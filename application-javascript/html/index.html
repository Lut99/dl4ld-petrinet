<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>

        <title>Petri Nets</title>

        <link rel="stylesheet" type="text/css" href="/html/joint.min.css" />
	<link rel="stylesheet" href="html/styles/w3.css">

    </head>
    <body>
	 <div class="w3-container w3-teal">
  		<h1>Petrinet Contracts</h1>
	</div>
	<div class="w3-sidebar w3-bar-block" style="width:15%">
	  <a href="#" class="w3-bar-item w3-button" onclick="showModal('x509'); return true;">My Info</a>
	  <button class="w3-button w3-block w3-left-align" onclick="myAccFunc('orgsAcc')">Organizations</button>
	  <div id="orgsAcc" class="w3-bar-block w3-hide w3-white w3-card-4">
	  </div>
	  <button class="w3-button w3-block w3-left-align" onclick="myAccFunc('netsAcc')">Nets</button>
	  <div id="netsAcc" class="w3-bar-block w3-hide w3-white w3-card-4">
	  </div>
	  <button class="w3-button w3-block w3-left-align" onclick="myAccFunc('placesAcc')">Places</button>
	  <div id="placesAcc" class="w3-bar-block w3-hide w3-white w3-card-4">
	  </div>
	  <button class="w3-button w3-block w3-left-align" onclick="myAccFunc('tokensAcc')">Tokens</button>
	  <div id="tokensAcc" class="w3-bar-block w3-hide w3-white w3-card-4">
	  </div>
	  <button class="w3-button w3-block w3-left-align" onclick="myAccFunc('transitionsAcc')">Transitions</button>
	  <div id="transitionsAcc" class="w3-bar-block w3-hide w3-white w3-card-4">
	  </div>


	</div>
	<div style="margin-left:15%">
		<div id="paper"></div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fake-smile@1.0.1/smil.user.min.js"></script>
        <script src="/node_modules/jquery/dist/jquery.js"></script>
        <script src="/node_modules/lodash/lodash.js"></script>
        <script src="/node_modules/backbone/backbone.js"></script>

        <script src="/html/joint.min.js"></script>
	<!--<script src="/html/pn.js"></script>-->

	<script>
/*
var graph = new joint.dia.Graph();
var paper = new joint.dia.Paper({
    el: document.getElementById('paper'),
    width: 1000,
    height: 650,
    gridSize: 10,
    defaultAnchor: { name: 'perpendicular' },
    defaultConnectionPoint: { name: 'boundary' },
    model: graph
});

var pn = joint.shapes.pn;

var pReady = new pn.Place({
    position: { x: 140, y: 50 },
    attrs: {
        '.label': {
            'text': 'ready',
            'fill': '#7c68fc' },
        '.root': {
            'stroke': '#9586fd',
            'stroke-width': 3
        },
        '.tokens > circle': {
            'fill': '#7a7e9b'
        }
    },
    tokens: 1
});

var pIdle = pReady.clone()
    .attr('.label/text', 'idle')
    .position(140, 260)
    .set('tokens', 2);

var buffer = pReady.clone()
    .position(350, 160)
    .set('tokens', 12)
    .attr({
        '.label': {
            'text': 'buffer'
        },
        '.alot > text': {
            'fill': '#fe854c',
            'font-family': 'Courier New',
            'font-size': 20,
            'font-weight': 'bold',
            'ref-x': 0.5,
            'ref-y': 0.5,
            'y-alignment': -0.5,
            'transform': null
        }
    });

var cAccepted = pReady.clone()
    .attr('.label/text', 'accepted')
    .position(550, 50)
    .set('tokens', 1);

var cReady = pReady.clone()
    .attr('.label/text', 'accepted')
    .position(560, 260)
    .set('ready', 3);

var pProduce = new pn.Transition({
    position: { x: 50, y: 160 },
    attrs: {
        '.label': {
            'text': 'produce',
            'fill': '#fe854f'
        },
        '.root': {
            'fill': '#9586fd',
            'stroke': '#9586fd'
        }
    }
});

var pSend = pProduce.clone()
    .attr('.label/text', 'send')
    .position(270, 160);

var cAccept = pProduce.clone()
    .attr('.label/text', 'accept')
    .position(470, 160);

var cConsume = pProduce.clone()
    .attr('.label/text', 'consume')
    .position(680, 160);


function link(a, b) {

    return new pn.Link({
        source: { id: a.id, selector: '.root' },
        target: { id: b.id, selector: '.root' },
        attrs: {
            '.connection': {
                'fill': 'none',
                'stroke-linejoin': 'round',
                'stroke-width': '2',
                'stroke': '#4b4a67'
            }
        }
    });
}

graph.addCell([pReady, pIdle, buffer, cAccepted, cReady, pProduce, pSend, cAccept, cConsume]);

graph.addCell([
   // link(pProduce, pReady),
    link(pReady, pSend),
    link(pSend, pIdle),
    link(pIdle, pProduce),
    link(pSend, buffer),
    link(buffer, cAccept),
    link(cAccept, cAccepted),
    link(cAccepted, cConsume),
    link(cConsume, cReady),
    link(cReady, cAccept)
]);


function fireTransition(t, sec) {

    var inbound = graph.getConnectedLinks(t, { inbound: true });
    var outbound = graph.getConnectedLinks(t, { outbound: true });

    var placesBefore = inbound.map(function(link) {
        return link.getSourceElement();
    });
    var placesAfter = outbound.map(function(link) {
        return link.getTargetElement();
    });

    var isFirable = true;
    placesBefore.forEach(function(p) {
        if (p.get('tokens') === 0) {
            isFirable = false;
        }
    });

    if (isFirable) {

        placesBefore.forEach(function(p) {
            // Let the execution finish before adjusting the value of tokens. So that we can loop over all transitions
            // and call fireTransition() on the original number of tokens.
            setTimeout(function() {
                p.set('tokens', p.get('tokens') - 1);
            }, 0);

            var links = inbound.filter(function(l) {
                return l.getSourceElement() === p;
            });

            links.forEach(function(l) {
                var token = V('circle', { r: 5, fill: '#feb662' });
                l.findView(paper).sendToken(token, sec * 1000);
            });
        });

        placesAfter.forEach(function(p) {

            var links = outbound.filter(function(l) {
                return l.getTargetElement() === p;
            });

            links.forEach(function(l) {
                var token = V('circle', { r: 5, fill: '#feb662' });
                l.findView(paper).sendToken(token, sec * 1000, function() {
                    p.set('tokens', p.get('tokens') + 1);
                });
            });
        });
    }
}

function simulate() {

    var transitions = [pProduce, pSend, cAccept, cConsume];
    transitions.forEach(function(t) {
        if (Math.random() < 0.7) {
            fireTransition(t, 1);
        }
    });

    return setInterval(function() {
        transitions.forEach(function(t) {
            if (Math.random() < 0.7) {
                fireTransition(t, 1);
            }
        });
    }, 2000);
}

var simulationId = simulate();

function stopSimulation(simulationId) {
    clearInterval(simulationId);
}
*/

	</script>

	<script>
		function myAccFunc(el) {
		  var x = document.getElementById(el);
		  if (x.className.indexOf("w3-show") == -1) {
		    x.className += " w3-show";
		    x.previousElementSibling.className += " w3-teal";
		  } else {
		    x.className = x.className.replace(" w3-show", "");
		    x.previousElementSibling.className =
		    x.previousElementSibling.className.replace(" w3-teal", "");
		  }
		}
		
		function addItemToAcc(el, item, onclick) {
		  var x = document.getElementById(el);
		  var i = document.createElement("A");
		  i.className = "w3-bar-item w3-button";
		  i.innerHTML = item;
		  i.setAttribute("href", "#");
		  if(!onclick) {
		  	i.setAttribute("onclick", `showModal('${item}'); return true;`);
		  } else {
		  	i.setAttribute("onclick", onclick +" return true;");
		  }
	          x.appendChild(i);
		  
		}

		function renderJSON(obj) {
		    'use strict';
		    var keys = [],
			retValue = "";
		    for (var key in obj) {
			if (typeof obj[key] === 'object') {
			    retValue += "<div class='tree'>" + key;
			    retValue += renderJSON(obj[key]);
			    retValue += "</div>";
			} else {
			    retValue += "<div class='tree'>" + key + " = " + obj[key] + "</div>";
			}

			keys.push(key);
		    }
		    return retValue;
		}

		function createModal(id, title, data) {
			const wrapper = document.createElement("DIV");
			wrapper.className += " w3-modal ";
			wrapper.id = id;
			const html = `<div class="w3-modal-content"> <header class="w3-container w3-teal"> <span onclick="document.getElementById('${id}').style.display='none'" class="w3-button w3-display-topright">&times;</span> <h3>${title}</h3> </header> <div class="w3-container"${renderJSON(data)}</div></div>`
			wrapper.innerHTML = html;
			document.body.appendChild(wrapper);
		}

		function showModal(id) {
			const modal = document.getElementById(id);
			if(modal) {
				modal.style.display='block';
			}
		}


		function drawNet(elId, netId) {
			var net = db.nets[netId];
			var graph = new joint.dia.Graph();
			var paper = new joint.dia.Paper({
			    el: document.getElementById(elId),
			    width: 1000,
			    height: 650,
			    gridSize: 10,
			    defaultAnchor: { name: 'perpendicular' },
			    defaultConnectionPoint: { name: 'boundary' },
			    model: graph
			});

			var pn = joint.shapes.pn;

			function link(a, b) {

			    return new pn.Link({
				source: { id: a.id, selector: '.root' },
				target: { id: b.id, selector: '.root' },
				attrs: {
				    '.connection': {
					'fill': 'none',
					'stroke-linejoin': 'round',
					'stroke-width': '2',
					'stroke': '#4b4a67'
				    }
				}
			    });
			}

			const cells = [];

			net.arcs.forEach(function(a) {
				const src = a.src;
				const dst = a.dst;
				if(src.type == 'place') {
					const sNode = new pn.Place({
					    position: { x: 50, y: 160 },
					    attrs: {
						'.label': {
						    'text': src.id,
						    'fill': '#7c68fc' },
						'.root': {
						    'stroke': '#9586fd',
						    'stroke-width': 3
						},
						'.tokens > circle': {
						    'fill': '#7a7e9b'
						}
					    },
					    tokens: 0
					});
					const dNode = new pn.Transition({
					    position: { x: 140, y: 50 },
					    attrs: {
						'.label': {
						    'text': dst.id,
						    'fill': '#fe854f'
						},
						'.root': {
						    'fill': '#9586fd',
						    'stroke': '#9586fd'
						}
					    }
					});
					graph.addCell([sNode, dNode]);
					graph.addCell([link(sNode,dNode)]);
				} 
			})


		}

	</script>


	<script> 
	
	  const db = {
		  myInfo: {},
		  orgs: {},
		  nets: {},
		  places: {},
		  tokens: {},
		  transitions: {}
	  }

	  function isNew(type, id) {
		  return (!db[type][id]);
	  }

	  $.when( $.ready ).then(function() {

		// open web socket
                socket = io()
                socket.emit('ready', '');
		socket.on('identity', function(data) {
			console.log("identity> ", data)
			createModal('x509', 'My Identity', JSON.parse(data));

		})

		socket.on('tokens', function(data) {
                	console.log("tokens> ", data);
			const tokens = JSON.parse(data);
			tokens.map(function(t){ return t.Record;})
				.forEach(function(t){
					if(isNew('tokens', t.id)) {
						db.tokens[t.id] = t;
						addItemToAcc('tokensAcc', t.id);
						createModal(t.id, `Token: ${t.id}`, t);
					}
				})

		})
		socket.on('places', function(data) {
                	console.log("places> ", data);
			const places = JSON.parse(data);
			places.map(function(p) {
				return p.Record;
				})
				.forEach(function(p){
					if(isNew("places", p.id)) {
						db.places[p.id] = p;
				        	addItemToAcc('placesAcc', p.id);
						createModal(p.id, `Place: ${p.id}`, p);
					}
				})

		})
		socket.on('transitions', function(data) {
                	console.log("transitions> ", data);
			const transitions = JSON.parse(data);
			transitions.map(function(t) { return t.Record; })
				.forEach(function(t) {
					if(isNew("transitions", t.id)) {
						db.transitions[t.id] = t;
						addItemToAcc('transitionsAcc', t.id);
						createModal(t.id, `Transition: ${t.id}`, t);
					}
				})
		})

                socket.on('net', function(data) {
                        console.log("nets> ", data);
			const nets = JSON.parse(data);
			nets.map(function(n) { return n.Record; })
				.forEach(function(n) {
					if(isNew("nets", n.id)) {
						db.nets[n.id] = n;
						addItemToAcc('netsAcc', n.id, `drawNet('paper', '${n.id}');`);
						//createModal(n.id, `Net: ${n.id}`, n);
						//drawNet('paper', n)
					}
				})
                })
		setTimeout(function() { console.log(db)}, 5000)

	  });

	</script>

</body>
</html>
